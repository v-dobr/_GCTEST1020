# <a name="call-microsoft-graph-in-a-service-or-daemon-app"></a>Вызов Microsoft Graph в службе или управляющем приложении

В этой статье описывается минимальный набор действий, необходимых для подключения одноклиентской службы или управляющего приложения к Office 365 и вызова API Microsoft Graph.

> Примечание. В этой статье предполагается, что вы используете Azure Active Directory в качестве поставщика проверки подлинности для приложения. Сведения о внедрении службы или управляющего приложения с помощью конечной точки Azure AD версии 2.0 см. в статье <a href="https://azure.microsoft.com/en-us/documentation/articles/active-directory-v2-protocols-oauth-client-creds/" target="_newtab">Протоколы версии 2.0: поток учетных данных клиента OAuth 2.0</a>.

## <a name="register-the-application-in-azure-active-directory"></a>Регистрация приложения в Azure Active Directory

Прежде чем приступить к работе с Office 365, вам потребуется зарегистрировать приложение на [портале Azure](https://portal.azure.com). Помните следующее:

- После регистрации приложения настройте его разрешения, необходимые для вашей службы или управляющей программы.
- Запишите указанные ниже значения при регистрации приложения Azure. Эти значения понадобятся для настройки потока OAuth в вашей службе или управляющей программе.
    * Идентификатор клиента (уникальный для приложения)
    * Ключ, или секрет, клиента (уникальный для приложения)
    * Конечная точка маркера OAuth 2.0 приложения
      * Чтобы найти это значение, нажмите *Просмотр конечных точек* в нижней части портала управления Azure на странице приложения. Конечная точка будет представлена в формате `https://login.microsoftonline.com/<tenantId>/oauth2/token`.

## <a name="request-an-access-token-from-the-token-issuing-endpoint"></a>Запрос токена доступа из конечной точки выдачи токенов

В отличие от клиентских приложений, служба или управляющее приложение не может управлять входом пользователя и авторизацией приложения. Поэтому в приложении необходимо реализовать поток предоставления клиентских учетных данных OAuth 2.0, который позволит ему использовать собственные учетные данные, идентификатор клиента и ключ приложения, для проверки подлинности при вызове Microsoft Graph, не действуя от имени пользователя. Подробные сведения о потоке проверки подлинности см. в статье [Вызовы службы службой с использованием клиентских учетных данных](https://msdn.microsoft.com/en-us/library/azure/dn645543.aspx).

Отправьте HTTP-запрос POST в конечную точку выдачи маркеров с указанными ниже параметрами, заменив параметры `<clientId>` и `<clientSecret>` на идентификатор клиента и ключ приложения соответственно.

```http
POST https://login.microsoftonline.com/<tenantId>/oauth2/token HTTP/1.1
Content-Type: application/x-www-form-urlencoded

grant_type=client_credentials
&client_id=<clientId>
&client_secret=<clientSecret>
&resource=https://graph.microsoft.com
```

Ответ будет содержать маркер доступа и сведения об истечении срока действия.

```json
{ 
  "token_type": "Bearer",
  "expires_in": "3599",
  "scope": "User.Read",
  "expires_on": "1449685363",
  "not_before": "1449681463",
  "resource": "https://graph.microsoft.com",
  "access_token": "<token>"
}
```

## <a name="use-the-access-token-in-a-request-to-the-microsoft-graph-api"></a>Использование токена доступа в запросе к API Microsoft Graph

Используя токен доступа, приложение может отправлять проверенные запросы в API Microsoft Graph. Приложение должно добавлять токен доступа в заголовок **Authorization** каждого запроса.

Например, служба и управляющая программа могут получить список всех пользователей клиента, если на портале управления Azure для них выбрано разрешение *Чтение полных профилей всех пользователей*. 

```http
GET https://graph.microsoft.com/v1.0/users
Authorization: Bearer <token>
```
